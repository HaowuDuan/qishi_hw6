<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel æ™ºèƒ½ä½“ - æ•°æ®åˆ†æåŠ©æ‰‹</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.4.0/axios.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <style>
        .code-block {
            background-color: #f4f4f4;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
        }
        .result-table {
            max-height: 400px;
            overflow-y: auto;
        }
        .analysis-result {
            max-height: 500px;
            overflow-y: auto;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
        }
        .code-result {
            max-height: 500px;
            overflow-y: auto;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
        }
        .voice-recording {
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">Excel æ™ºèƒ½ä½“</h1>
            <p class="text-gray-600">ä¸Šä¼ Excelæ–‡ä»¶ï¼Œç”¨è‡ªç„¶è¯­è¨€æè¿°åˆ†æéœ€æ±‚ï¼ŒAIå°†è‡ªåŠ¨ç”ŸæˆPythonä»£ç å¹¶æ‰§è¡Œåˆ†æ</p>
        </div>

        <!-- Main Content -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Left Panel: File Upload & Input -->
            <div class="space-y-6">
                <!-- File Upload -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-xl font-semibold mb-4">1. ä¸Šä¼ Excelæ–‡ä»¶</h2>
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                        <input type="file" id="fileInput" accept=".xlsx,.xls" class="hidden">
                        <button onclick="document.getElementById('fileInput').click()" 
                                class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg transition-colors">
                            é€‰æ‹©Excelæ–‡ä»¶
                        </button>
                        <p class="text-gray-500 mt-2">æ”¯æŒ .xlsx å’Œ .xls æ ¼å¼</p>
                    </div>
                    <div id="fileInfo" class="mt-4 hidden">
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                            <p class="text-green-800 font-medium">æ–‡ä»¶ä¸Šä¼ æˆåŠŸ</p>
                            <p id="fileName" class="text-green-600 text-sm"></p>
                        </div>
                    </div>
                </div>

                <!-- Natural Language Input -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-xl font-semibold mb-4">2. æè¿°åˆ†æéœ€æ±‚</h2>
                    <div class="space-y-4">
                        <!-- Text Input -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">è‡ªç„¶è¯­è¨€è¾“å…¥</label>
                            <textarea id="queryInput" 
                                    placeholder="ä¾‹å¦‚ï¼šå¸®æˆ‘åˆ†æå„åœ°åŒºé”€å”®è¶‹åŠ¿ï¼ŒæŒ‰æœˆä»½ç»Ÿè®¡é”€å”®é¢"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    rows="3"></textarea>
                        </div>

                        <!-- Voice Input -->
                        <div class="space-y-2">
                            <div class="flex items-center space-x-4">
                                <button id="voiceBtn" 
                                        class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors flex items-center space-x-2">
                                    <span>ğŸ¤</span>
                                    <span id="voiceBtnText">è¯­éŸ³è¾“å…¥</span>
                                </button>
                                <p class="text-sm text-gray-500">ç‚¹å‡»å¼€å§‹å½•éŸ³ï¼Œå†æ¬¡ç‚¹å‡»åœæ­¢</p>
                            </div>
                            <div id="voiceStatus" class="hidden text-sm text-blue-600">
                                <span class="inline-block w-2 h-2 bg-blue-500 rounded-full animate-pulse mr-2"></span>
                                <span id="voiceStatusText">æ­£åœ¨å¤„ç†è¯­éŸ³...</span>
                            </div>
                        </div>

                        <!-- Submit Button -->
                        <button id="analyzeBtn" 
                                class="w-full bg-purple-500 hover:bg-purple-600 text-white px-6 py-3 rounded-lg transition-colors disabled:bg-gray-400"
                                disabled>
                            å¼€å§‹åˆ†æ
                        </button>
                    </div>
                </div>
            </div>

            <!-- Right Panel: Results -->
            <div class="space-y-6">
                <!-- Analysis Results -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-xl font-semibold mb-4">åˆ†æç»“æœ</h2>
                    <div id="results" class="space-y-4">
                        <div class="text-gray-500 text-center py-8">
                            è¯·å…ˆä¸Šä¼ æ–‡ä»¶å¹¶è¾“å…¥åˆ†æéœ€æ±‚
                        </div>
                    </div>
                </div>

                <!-- Generated Code -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-xl font-semibold mb-4">ç”Ÿæˆçš„Pythonä»£ç </h2>
                    <div id="generatedCode" class="code-block text-sm">
                        <div class="text-gray-500 text-center py-4">
                            ä»£ç å°†åœ¨è¿™é‡Œæ˜¾ç¤º
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
        // Global variables
        let socket;
        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;
        let currentFile = null;
        let currentFileId = null;

        // Initialize WebSocket connection
        function initSocket() {
            socket = io();
            
            socket.on('connect', function() {
                console.log('Connected to server');
            });

            socket.on('voice_result', function(data) {
                console.log('Voice recognition result:', data.text);
                
                // éšè—çŠ¶æ€æŒ‡ç¤ºå™¨
                document.getElementById('voiceStatus').classList.add('hidden');
                
                // æ›´æ–°è¾“å…¥æ¡†å†…å®¹
                const currentText = document.getElementById('queryInput').value;
                const newText = data.text;
                
                // å¦‚æœè¯†åˆ«æˆåŠŸä¸”ä¸æ˜¯é”™è¯¯ä¿¡æ¯ï¼Œåˆ™æ›´æ–°è¾“å…¥æ¡†
                if (newText && !newText.includes('æŠ±æ­‰') && !newText.includes('è¯­éŸ³è¯†åˆ«') && !newText.includes('å‡ºé”™')) {
                    document.getElementById('queryInput').value = newText;
                    console.log('Voice input successfully recognized and added to text area');
                } else {
                    // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                    alert('è¯­éŸ³è¯†åˆ«ç»“æœ: ' + newText);
                }
                
                // é‡ç½®æŒ‰é’®çŠ¶æ€
                document.getElementById('voiceBtnText').textContent = 'è¯­éŸ³è¾“å…¥';
                document.getElementById('voiceBtn').classList.remove('voice-recording');
                isRecording = false;
            });

            socket.on('error', function(data) {
                console.error('WebSocket error:', data.message);
                alert('è¯­éŸ³å¤„ç†é”™è¯¯: ' + data.message);
                
                // éšè—çŠ¶æ€æŒ‡ç¤ºå™¨
                document.getElementById('voiceStatus').classList.add('hidden');
                
                // é‡ç½®æŒ‰é’®çŠ¶æ€
                document.getElementById('voiceBtnText').textContent = 'è¯­éŸ³è¾“å…¥';
                document.getElementById('voiceBtn').classList.remove('voice-recording');
                isRecording = false;
            });
        }

        // File upload handling
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                uploadFile(file);
            }
        });

        function uploadFile(file) {
            const formData = new FormData();
            formData.append('file', file);

            axios.post('/upload', formData, {
                headers: {
                    'Content-Type': 'multipart/form-data'
                }
            })
            .then(response => {
                console.log('Upload response:', response.data);
                if (response.data.success) {
                    currentFile = file;
                    currentFileId = response.data.file_id;
                    document.getElementById('fileInfo').classList.remove('hidden');
                    document.getElementById('fileName').textContent = file.name;
                    
                    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                    alert('âœ… æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼æ­£åœ¨é¢„å¤„ç†ä¸­ï¼Œè¯·ç¨å€™...');
                    
                    // å¼€å§‹æ£€æŸ¥é¢„å¤„ç†çŠ¶æ€
                    checkPreprocessingStatus();
                } else {
                    alert('æ–‡ä»¶ä¸Šä¼ å¤±è´¥: ' + response.data.error);
                }
            })
            .catch(error => {
                console.error('Upload error:', error);
                alert('æ–‡ä»¶ä¸Šä¼ å¤±è´¥');
            });
        }

        function checkPreprocessingStatus() {
            console.log('=== checkPreprocessingStatus called ===');
            console.log('currentFileId:', currentFileId);
            console.log('typeof currentFileId:', typeof currentFileId);
            
            if (!currentFileId) {
                console.error('No currentFileId, cannot check preprocessing status');
                alert('é”™è¯¯ï¼šæ–‡ä»¶IDä¸¢å¤±ï¼Œè¯·é‡æ–°ä¸Šä¼ æ–‡ä»¶');
                return;
            }
            
            console.log('Sending check_preprocessing request...');
            axios.post('/check_preprocessing', {
                file_id: currentFileId
            })
            .then(response => {
                console.log('=== Preprocessing check response ===');
                console.log('Response status:', response.status);
                console.log('Response data:', response.data);
                console.log('Response data type:', typeof response.data);
                console.log('Response data.success:', response.data.success);
                console.log('Response data.status:', response.data.status);
                console.log('Response data keys:', Object.keys(response.data));
                
                // æ£€æŸ¥å“åº”æ˜¯å¦æœ‰æ•ˆ
                if (!response.data) {
                    console.error('âŒ No response data received');
                    alert('é¢„å¤„ç†æ£€æŸ¥å¤±è´¥ï¼šæ²¡æœ‰æ”¶åˆ°å“åº”æ•°æ®');
                    return;
                }
                
                // æ£€æŸ¥ success å­—æ®µ
                if (response.data.success === true) {
                    if (response.data.status === 'completed') {
                        console.log('âœ… Preprocessing completed, enabling analyze button');
                        document.getElementById('analyzeBtn').disabled = false;
                        showDataPreview(response.data.data_preview, response.data.columns);
                        alert('ğŸ‰ æ–‡ä»¶é¢„å¤„ç†å®Œæˆï¼ç°åœ¨å¯ä»¥å¼€å§‹åˆ†æäº†ã€‚');
                    } else {
                        console.log('â³ Preprocessing not completed yet, checking again in 1 second');
                        // ç»§ç»­æ£€æŸ¥é¢„å¤„ç†çŠ¶æ€
                        setTimeout(checkPreprocessingStatus, 1000);
                    }
                } else {
                    console.error('âŒ Preprocessing check failed:', response.data.error);
                    console.error('Success value:', response.data.success);
                    console.error('Success type:', typeof response.data.success);
                    alert('é¢„å¤„ç†æ£€æŸ¥å¤±è´¥: ' + (response.data.error || 'æœªçŸ¥é”™è¯¯'));
                }
            })
            .catch(error => {
                console.error('âŒ Check preprocessing error:', error);
                console.error('Error details:', error.response?.data);
                alert('é¢„å¤„ç†æ£€æŸ¥å‡ºé”™: ' + error.message);
            });
        }

        function showDataPreview(data, columns) {
            const resultsDiv = document.getElementById('results');
            
            // æ£€æŸ¥æ•°æ®è´¨é‡
            const hasUnnamedColumns = columns.some(col => col.startsWith('Unnamed'));
            const hasDuplicateColumns = columns.length !== new Set(columns).size;
            
            let warningMessage = '';
            if (hasUnnamedColumns || hasDuplicateColumns) {
                warningMessage = `
                    <div class="mb-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                        <h4 class="font-semibold text-yellow-800 mb-2">âš ï¸ æ•°æ®è´¨é‡è­¦å‘Š</h4>
                        <p class="text-yellow-700 text-sm">
                            ${hasUnnamedColumns ? 'â€¢ æ£€æµ‹åˆ°æœªå‘½åçš„åˆ—ï¼Œå¯èƒ½å½±å“åˆ†æç»“æœ<br>' : ''}
                            ${hasDuplicateColumns ? 'â€¢ æ£€æµ‹åˆ°é‡å¤çš„åˆ—åï¼Œå¯èƒ½å½±å“åˆ†æç»“æœ<br>' : ''}
                            å»ºè®®æ£€æŸ¥åŸå§‹Excelæ–‡ä»¶çš„è¡¨å¤´è®¾ç½®
                        </p>
                    </div>
                `;
            }
            
            resultsDiv.innerHTML = `
                ${warningMessage}
                <div class="mb-4">
                    <h3 class="font-semibold text-gray-700 mb-2">æ•°æ®é¢„è§ˆ</h3>
                    <div class="result-table">
                        <table class="min-w-full border border-gray-300">
                            <thead class="bg-gray-50">
                                <tr>
                                    ${columns.map(col => `<th class="px-3 py-2 border border-gray-300 text-left">${col}</th>`).join('')}
                                </tr>
                            </thead>
                            <tbody>
                                ${data.slice(0, 10).map(row => `
                                    <tr>
                                        ${Object.values(row).map(cell => `<td class="px-3 py-2 border border-gray-300">${cell}</td>`).join('')}
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    <p class="text-sm text-gray-500 mt-2">æ˜¾ç¤ºå‰10è¡Œæ•°æ®ï¼Œå®Œæ•´æ•°æ®å°†åœ¨åˆ†ææ—¶ä½¿ç”¨</p>
                </div>
            `;
        }

        // Voice input handling
        document.getElementById('voiceBtn').addEventListener('click', function() {
            if (!isRecording) {
                startRecording();
            } else {
                stopRecording();
            }
        });

        async function startRecording() {
            try {
                // è¯·æ±‚éº¦å…‹é£æƒé™ï¼Œä½¿ç”¨æ›´é«˜è´¨é‡çš„éŸ³é¢‘è®¾ç½®
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true,
                        sampleRate: 44100
                    } 
                });
                
                // ä½¿ç”¨WAVæ ¼å¼è¿›è¡Œå½•åˆ¶
                const options = { mimeType: 'audio/webm;codecs=opus' };
                if (MediaRecorder.isTypeSupported('audio/wav')) {
                    options.mimeType = 'audio/wav';
                }
                
                mediaRecorder = new MediaRecorder(stream, options);
                audioChunks = [];

                mediaRecorder.ondataavailable = function(event) {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };

                mediaRecorder.onstop = function() {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    
                    // æ£€æŸ¥éŸ³é¢‘é•¿åº¦ï¼Œå¤ªçŸ­çš„éŸ³é¢‘å¯èƒ½æ— æ³•è¯†åˆ«
                    if (audioBlob.size < 1000) {
                        alert('å½•éŸ³æ—¶é—´å¤ªçŸ­ï¼Œè¯·é‡æ–°å½•åˆ¶');
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = function() {
                        const base64Audio = reader.result.split(',')[1];
                        console.log('Sending audio data via WebSocket...');
                        socket.emit('voice_input', { audio: base64Audio });
                    };
                    reader.readAsDataURL(audioBlob);
                };

                // å¼€å§‹å½•åˆ¶ï¼Œæ¯100msæ”¶é›†ä¸€æ¬¡æ•°æ®
                mediaRecorder.start(100);
                isRecording = true;
                document.getElementById('voiceBtnText').textContent = 'åœæ­¢å½•éŸ³';
                document.getElementById('voiceBtn').classList.add('voice-recording');
                
                // æ˜¾ç¤ºå½•éŸ³çŠ¶æ€
                document.getElementById('voiceStatus').classList.remove('hidden');
                document.getElementById('voiceStatusText').textContent = 'æ­£åœ¨å½•éŸ³...';
                
                console.log('Recording started...');
            } catch (error) {
                console.error('Error accessing microphone:', error);
                alert('æ— æ³•è®¿é—®éº¦å…‹é£ï¼Œè¯·æ£€æŸ¥æƒé™è®¾ç½®ã€‚é”™è¯¯: ' + error.message);
            }
        }

        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
                isRecording = false;
                document.getElementById('voiceBtnText').textContent = 'è¯­éŸ³è¾“å…¥';
                document.getElementById('voiceBtn').classList.remove('voice-recording');
                
                // æ›´æ–°çŠ¶æ€ä¸ºå¤„ç†ä¸­
                document.getElementById('voiceStatusText').textContent = 'æ­£åœ¨è¯†åˆ«è¯­éŸ³...';
                
                console.log('Recording stopped, processing audio...');
            }
        }

        // Analysis handling
        document.getElementById('analyzeBtn').addEventListener('click', function() {
            console.log('Analyze button clicked!');
            console.log('Button disabled:', document.getElementById('analyzeBtn').disabled);
            console.log('Current file:', currentFile);
            console.log('Current file ID:', currentFileId);
            
            const query = document.getElementById('queryInput').value.trim();
            console.log('Query input:', query);
            
            if (!query) {
                alert('è¯·è¾“å…¥åˆ†æéœ€æ±‚');
                return;
            }

            if (!currentFile) {
                alert('è¯·å…ˆä¸Šä¼ Excelæ–‡ä»¶');
                return;
            }

            performAnalysis(query);
        });

        function performAnalysis(query) {
            console.log('Starting analysis with query:', query);
            console.log('Current file ID:', currentFileId);
            
            if (!currentFileId) {
                alert('é”™è¯¯ï¼šæ–‡ä»¶IDä¸¢å¤±ï¼Œè¯·é‡æ–°ä¸Šä¼ æ–‡ä»¶');
                return;
            }
            
            document.getElementById('analyzeBtn').disabled = true;
            document.getElementById('analyzeBtn').textContent = 'åˆ†æä¸­...';

            console.log('Sending analysis request...');
            axios.post('/analyze', {
                query: query,
                file_id: currentFileId
            })
            .then(response => {
                console.log('Analysis response:', response.data);
                if (response.data.success) {
                    displayResults(response.data);
                    alert('ğŸ‰ åˆ†æå®Œæˆï¼è¯·æŸ¥çœ‹ç»“æœã€‚');
                } else {
                    console.error('Analysis failed:', response.data.error);
                    alert('åˆ†æå¤±è´¥: ' + response.data.error);
                }
            })
            .catch(error => {
                console.error('Analysis error:', error);
                console.error('Error details:', error.response?.data);
                alert('åˆ†æå¤±è´¥: ' + (error.response?.data?.error || error.message));
            })
            .finally(() => {
                document.getElementById('analyzeBtn').disabled = false;
                document.getElementById('analyzeBtn').textContent = 'å¼€å§‹åˆ†æ';
            });
        }

        function displayResults(data) {
            // Display generated code
            document.getElementById('generatedCode').innerHTML = 
                `<div class="code-result">${data.generated_code}</div>`;

            // Display results
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = `
                <div class="mb-4">
                    <h3 class="font-semibold text-gray-700 mb-2">åˆ†æç»“æœ</h3>
                    <div class="analysis-result">${data.result}</div>
                </div>
            `;

        }

        // Initialize the application
        initSocket();
    </script>
</body>
</html>
